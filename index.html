<!DOCTYPE html>
<html lang="fa" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ØªØ±Ø¬Ù… Ø²ÛŒØ±Ù†ÙˆÛŒØ³ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³ÛŒÙ†Ù…Ø§ÛŒÛŒ</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        pop: {
                            blue: '#3b82f6',
                            blueDark: '#2563eb',
                            purple: '#8b5cf6',
                            purpleDark: '#7c3aed',
                            red: '#ef4444',
                            redDark: '#dc2626',
                            gray: '#f3f4f6',
                            grayDark: '#d1d5db',
                            surface: '#ffffff',
                            surfaceDark: '#1f2937'
                        }
                    },
                    fontFamily: {
                        sans: ['Vazirmatn', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-down': 'slideDown 0.2s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        slideDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)', maxHeight: '0' },
                            '100%': { opacity: '1', transform: 'translateY(0)', maxHeight: '100px' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap');
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            transition: background-color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        /* 3D Button Style */
        .btn-pop {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom-width: 3px; 
            transform: translateY(0);
        }
        .btn-pop:active {
            border-bottom-width: 0px;
            transform: translateY(3px);
            margin-top: 3px;
        }

        .btn-blue { background-color: #3b82f6; border-color: #2563eb; color: white; }
        .btn-purple { background-color: #8b5cf6; border-color: #7c3aed; color: white; }
        .btn-red { background-color: #ef4444; border-color: #dc2626; color: white; }
        .btn-gray { background-color: #f3f4f6; border-color: #d1d5db; color: #374151; }
        .dark .btn-gray { background-color: #374151; border-color: #1f2937; color: #f3f4f6; }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .dark .glass {
            background: rgba(17, 24, 39, 0.95);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        .subtitle-card {
            content-visibility: auto;
            contain-intrinsic-size: 100px;
        }
        
        .subtitle-card.active {
            border-right: 4px solid #3b82f6;
            background-color: rgba(59, 130, 246, 0.15);
            content-visibility: visible;
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden bg-gray-50 text-gray-800 dark:bg-gray-950 dark:text-gray-100">

    <!-- Header -->
    <header class="glass sticky top-0 z-30 px-4 py-3 flex justify-between items-center shadow-sm shrink-0">
        <div class="flex items-center gap-3">
            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-pink-600 to-purple-600 rounded-lg blur opacity-25 group-hover:opacity-75 transition duration-200"></div>
                <div class="relative bg-white dark:bg-gray-800 p-2 rounded-lg text-purple-600 dark:text-purple-400">
                    <i class="fa-solid fa-closed-captioning text-2xl"></i>
                    <i class="fa-solid fa-wand-magic-sparkles text-xs absolute -top-1 -right-1 text-yellow-500 animate-pulse"></i>
                </div>
            </div>
            <div class="flex flex-col">
                <h1 class="text-lg font-black tracking-tight text-gray-800 dark:text-white leading-tight">
                    Subtitle<span class="text-purple-600 dark:text-purple-400">AI</span>
                </h1>
                <span class="text-[10px] text-gray-500 dark:text-gray-400 font-bold -mt-1 hidden sm:block">Ù…ØªØ±Ø¬Ù… Ø³ÛŒÙ†Ù…Ø§ÛŒÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</span>
            </div>
        </div>
        
        <div class="flex gap-2">
            <button onclick="toggleHistory()" class="btn-pop btn-gray w-10 h-10 rounded-xl flex items-center justify-center text-lg relative" title="ØªØ§Ø±ÛŒØ®Ú†Ù‡">
                <i class="fa-solid fa-clock-rotate-left"></i>
            </button>
            <button onclick="toggleTheme()" class="btn-pop btn-gray w-10 h-10 rounded-xl flex items-center justify-center text-lg">
                <i class="fa-solid fa-moon dark:hidden"></i>
                <i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i>
            </button>
            <button onclick="toggleSettings()" class="btn-pop btn-gray px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2">
                <i class="fa-solid fa-sliders text-base"></i>
                <span class="hidden sm:inline">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span>
            </button>
            
            <div class="relative">
                <button onclick="toggleDownloadMenu(event)" class="btn-pop btn-blue px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2">
                    <i class="fa-solid fa-download text-base"></i>
                    <span class="hidden sm:inline">Ø¯Ø§Ù†Ù„ÙˆØ¯</span>
                </button>
                <div id="downloadMenu" class="hidden absolute left-0 top-full mt-2 w-32 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 z-50 overflow-hidden transform origin-top-left transition-all animate-fade-in">
                    <button onclick="exportSubtitle('srt'); toggleDownloadMenu(event)" class="w-full text-right px-4 py-3 text-xs font-bold hover:bg-gray-100 dark:hover:bg-gray-700 flex justify-between items-center text-gray-700 dark:text-gray-200 transition">
                        SRT <i class="fa-solid fa-file-lines text-blue-500"></i>
                    </button>
                    <div class="border-t border-gray-100 dark:border-gray-700"></div>
                    <button onclick="exportSubtitle('vtt'); toggleDownloadMenu(event)" class="w-full text-right px-4 py-3 text-xs font-bold hover:bg-gray-100 dark:hover:bg-gray-700 flex justify-between items-center text-gray-700 dark:text-gray-200 transition">
                        VTT <i class="fa-solid fa-closed-captioning text-purple-500"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex justify-center items-center p-4" onclick="handleModalClick(event)">
        <div class="bg-white dark:bg-gray-900 w-full max-w-md rounded-2xl shadow-2xl flex flex-col max-h-[80vh] border border-gray-200 dark:border-gray-800 animate-fade-in">
            <div class="px-5 py-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
                <h3 class="font-black text-gray-700 dark:text-white flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left text-blue-500"></i> Ù¾Ø±ÙˆÚ˜Ù‡ Ù‡Ø§ÛŒ Ø§Ø®ÛŒØ±
                </h3>
                <button onclick="toggleHistory()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="historyList" class="flex-1 overflow-y-auto p-3 space-y-2">
                <!-- History Items -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex justify-center items-end sm:items-center sm:p-4 transition-all" onclick="handleModalClick(event)">
        <div class="bg-white dark:bg-gray-900 w-full sm:max-w-3xl sm:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col max-h-[85vh] animate-fade-in border border-gray-200 dark:border-gray-800">
            
            <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center shrink-0 bg-gray-50 dark:bg-gray-900/50 sm:rounded-t-3xl">
                <h2 class="text-lg font-black text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fa-solid fa-gear text-purple-500"></i> ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ±Ø¬Ù…Ù‡
                </h2>
                <button onclick="toggleSettings()" class="bg-gray-200 dark:bg-gray-800 text-gray-500 hover:text-red-500 w-8 h-8 rounded-full flex items-center justify-center transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="p-6 space-y-6 overflow-y-auto custom-scrollbar flex-1">
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setService('gemini')" id="btn-gemini" class="btn-pop p-4 rounded-2xl text-sm font-bold flex flex-col items-center gap-2 border-2 transition-all">
                        <i class="fa-brands fa-google text-2xl"></i> 
                        <span>Google Gemini</span>
                    </button>
                    <button onclick="setService('openrouter')" id="btn-openrouter" class="btn-pop p-4 rounded-2xl text-sm font-bold flex flex-col items-center gap-2 border-2 transition-all">
                        <i class="fa-solid fa-microchip text-2xl"></i> 
                        <span>OpenRouter</span>
                    </button>
                </div>

                <!-- API Key Management (MULTI-KEY UI) -->
                <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-2xl border border-gray-100 dark:border-gray-700">
                    <label class="block text-xs font-black mb-2 text-gray-500 dark:text-gray-400 uppercase tracking-wide">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ API (Ù‡ÙˆØ´Ù…Ù†Ø¯)</label>
                    
                    <!-- Add Input -->
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="newKeyInput" class="w-full bg-white dark:bg-gray-900 border-2 border-gray-200 dark:border-gray-700 focus:border-purple-500 rounded-xl py-3 px-4 text-sm outline-none dir-ltr font-mono text-gray-800 dark:text-gray-200 transition-colors" placeholder="Ú©Ù„ÛŒØ¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
                        <button onclick="addKeyFromInput()" class="btn-pop btn-blue px-4 rounded-xl text-white"><i class="fa-solid fa-plus text-lg"></i></button>
                    </div>

                    <!-- Hidden Input for Logic Compatibility -->
                    <input type="hidden" id="apiKeysInput">

                    <!-- Visual List -->
                    <div id="keysListDisplay" class="space-y-2 mb-3 max-h-32 overflow-y-auto custom-scrollbar">
                        <!-- Keys injected here -->
                    </div>

                    <div class="flex justify-between items-center mt-2">
                        <button onclick="checkConnection()" id="checkConnBtn" class="text-xs font-bold text-blue-500 hover:text-blue-600 transition">
                            <i class="fa-solid fa-wifi mr-1"></i> Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ Ú©Ù„ÛŒØ¯Ù‡Ø§
                        </button>
                        <div id="connectionStatus" class="text-xs font-bold h-4"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-black text-gray-500 dark:text-gray-400 uppercase">Ù…Ø¯Ù„ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</label>
                            <button onclick="refreshModels()" id="refreshModelsBtn" class="text-[10px] bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-2 py-1 rounded-lg font-bold hover:bg-blue-200 transition">
                                <i class="fa-solid fa-rotate mr-1"></i> Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„
                            </button>
                        </div>
                        <div class="relative">
                            <select id="modelSelect" class="w-full bg-gray-100 dark:bg-gray-800 rounded-xl py-3 px-4 text-sm border-r-8 border-transparent outline-none dir-ltr font-bold text-gray-700 dark:text-gray-200 appearance-none">
                                <option value="" disabled selected>Ø§Ø¨ØªØ¯Ø§ Ú©Ù„ÛŒØ¯ API Ø±Ø§ ÙˆØ§Ø±Ø¯ Ùˆ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†ÛŒØ¯</option>
                            </select>
                            <div class="absolute left-3 top-3.5 pointer-events-none text-gray-400"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black mb-2 text-gray-500 dark:text-gray-400 uppercase">Ø²Ø¨Ø§Ù† Ù…Ù‚ØµØ¯</label>
                        <div class="relative">
                            <select id="targetLang" class="w-full bg-gray-100 dark:bg-gray-800 rounded-xl py-3 px-4 text-sm border-r-8 border-transparent outline-none dir-ltr font-bold text-gray-700 dark:text-gray-200 appearance-none">
                                <optgroup label="Popular">
                                    <option value="Persian">ÙØ§Ø±Ø³ÛŒ (Persian)</option>
                                    <option value="English">Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ (English)</option>
                                    <option value="Arabic">Ø¹Ø±Ø¨ÛŒ (Arabic)</option>
                                    <option value="Turkish">ØªØ±Ú©ÛŒ (Turkish)</option>
                                    <option value="Kurdish">Ú©Ø±Ø¯ÛŒ (Kurdish)</option>
                                    <option value="German">Ø¢Ù„Ù…Ø§Ù†ÛŒ (German)</option>
                                    <option value="French">ÙØ±Ø§Ù†Ø³ÙˆÛŒ (French)</option>
                                </optgroup>
                                <optgroup label="Others">
                                    <option value="Spanish">Ø§Ø³Ù¾Ø§Ù†ÛŒØ§ÛŒÛŒ (Spanish)</option>
                                    <option value="Italian">Ø§ÛŒØªØ§Ù„ÛŒØ§ÛŒÛŒ (Italian)</option>
                                    <option value="Russian">Ø±ÙˆØ³ÛŒ (Russian)</option>
                                    <option value="Japanese">Ú˜Ø§Ù¾Ù†ÛŒ (Japanese)</option>
                                    <option value="Korean">Ú©Ø±Ù‡â€ŒØ§ÛŒ (Korean)</option>
                                    <option value="Chinese">Ú†ÛŒÙ†ÛŒ (Chinese)</option>
                                </optgroup>
                            </select>
                            <div class="absolute left-3 top-3.5 pointer-events-none text-gray-400"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                        </div>
                    </div>
                </div>

                <div>
                     <label class="block text-xs font-black mb-2 text-gray-500 dark:text-gray-400 uppercase">Ù„Ø­Ù† Ùˆ Ø³Ø¨Ú© ØªØ±Ø¬Ù…Ù‡</label>
                     <div class="relative">
                        <select id="toneSelect" class="w-full bg-gray-100 dark:bg-gray-800 rounded-xl py-3 px-4 text-sm border-r-8 border-transparent outline-none font-bold text-gray-700 dark:text-gray-200 appearance-none">
                            <option value="standard">Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ (ØªØ±Ø¬Ù…Ù‡ Ø±Ø³Ù…ÛŒ Ùˆ Ù…Ø¹Ù…ÙˆÙ„ÛŒ)</option>
                            <option value="uncensored">ğŸ”¥ Ø¨Ø¯ÙˆÙ† Ø³Ø§Ù†Ø³ÙˆØ± (Ø±Ú©ØŒ Ø®ÛŒØ§Ø¨Ø§Ù†ÛŒ Ùˆ Ú©Ø§Ù…Ù„Ø§ Ø¨Ø§Ø²)</option>
                            <option value="casual">Ù…Ø­Ø§ÙˆØ±Ù‡â€ŒØ§ÛŒ (Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¯Ù…ÙˆÙ†ÛŒ Ùˆ Ø±Ø§Ø­Øª)</option>
                            <option value="slang">Ø§Ø³Ù„Ù†Ú¯ (Ù¾Ø± Ø§Ø² Ø§ØµØ·Ù„Ø§Ø­Ø§Øª Ú©ÙˆÚ†Ù‡ Ø¨Ø§Ø²Ø§Ø±ÛŒ)</option>
                            <option value="action">Ø§Ú©Ø´Ù† (ØªÙ†Ø¯ Ùˆ ØªÛŒØ² ÙˆÙ„ÛŒ Ù…Ø­Ø§ÙˆØ±Ù‡â€ŒØ§ÛŒ)</option>
                            <option value="drama">Ø¯Ø±Ø§Ù… (Ø§Ø­Ø³Ø§Ø³ÛŒ ÙˆÙ„ÛŒ Ú¯ÙØªØ§Ø±ÛŒ Ùˆ Ø±ÙˆØ§Ù†)</option>
                            <option value="comedy">Ú©Ù…Ø¯ÛŒ (Ø¨Ø§Ù…Ø²Ù‡ Ùˆ Ø¨Ø§Ø­Ø§Ù„)</option>
                            <option value="historical">ØªØ§Ø±ÛŒØ®ÛŒ (Ø§Ø¯Ø¨ÛŒ Ú©Ù‡Ù†)</option>
                            <option value="scifi">Ø¹Ù„Ù…ÛŒâ€ŒØªØ®ÛŒÙ„ÛŒ (Ø¢ÛŒÙ†Ø¯Ù‡â€ŒÙ†Ú¯Ø± ÙˆÙ„ÛŒ Ø±ÙˆØ§Ù†)</option>
                            <option value="horror">ØªØ±Ø³Ù†Ø§Ú© (Ø¯Ù„Ù‡Ø±Ù‡â€ŒØ¢ÙˆØ± Ùˆ Ù…Ø­Ø§ÙˆØ±Ù‡â€ŒØ§ÛŒ)</option>
                            <option value="kids">Ú©ÙˆØ¯Ú©Ø§Ù†Ù‡ (Ø³Ø§Ø¯Ù‡ Ùˆ Ø´ÛŒØ±ÛŒÙ†)</option>
                        </select>
                        <div class="absolute left-3 top-3.5 pointer-events-none text-gray-400"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                     </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="flex justify-between text-xs font-black mb-2 text-gray-500 dark:text-gray-400 uppercase">
                            <span>Ù…ÛŒØ²Ø§Ù† Ø®Ù„Ø§Ù‚ÛŒØª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</span>
                            <span id="tempValue" class="text-purple-500 font-mono">0.3</span>
                        </div>
                        <input type="range" id="tempRange" min="0" max="1" step="0.1" class="w-full accent-purple-500 h-2 bg-gray-200 dark:bg-gray-800 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <div>
                        <div class="flex justify-between text-xs font-black mb-2 text-gray-500 dark:text-gray-400 uppercase">
                            <span>ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·ÙˆØ· Ø¯Ø± Ù‡Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª</span>
                            <span id="chunkValue" class="text-blue-500 font-mono">20</span>
                        </div>
                        <input type="range" id="chunkRange" min="5" max="100" step="5" class="w-full accent-blue-500 h-2 bg-gray-200 dark:bg-gray-800 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
            </div>

            <div class="p-5 border-t border-gray-100 dark:border-gray-800 shrink-0 bg-gray-50 dark:bg-gray-900/50 sm:rounded-b-3xl">
                <button onclick="saveSettings(); toggleSettings();" class="btn-pop btn-purple w-full py-3 rounded-2xl text-base font-black shadow-lg shadow-purple-500/20">
                    <i class="fa-solid fa-check mr-2"></i> Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- Upload Overlay -->
        <div id="uploadOverlay" class="absolute inset-0 z-20 bg-gray-50 dark:bg-gray-950 flex flex-col items-center justify-center p-6 text-center transition-opacity duration-300">
            <div class="border-4 border-dashed border-gray-300 dark:border-gray-800 rounded-[2rem] p-8 sm:p-16 w-full max-w-lg hover:border-purple-400 dark:hover:border-purple-500 transition-all duration-300 cursor-pointer group bg-white/50 dark:bg-gray-900/50 backdrop-blur-sm" onclick="document.getElementById('fileInput').click()">
                <div class="w-28 h-28 bg-purple-50 dark:bg-purple-900/20 rounded-full flex items-center justify-center mx-auto mb-8 group-hover:scale-110 group-hover:rotate-3 transition-transform duration-300 shadow-2xl shadow-purple-500/10">
                    <i class="fa-solid fa-cloud-arrow-up text-6xl text-purple-500"></i>
                </div>
                <h2 class="text-3xl font-black mb-4 text-gray-800 dark:text-white tracking-tight">ÙØ§ÛŒÙ„ Ø²ÛŒØ±Ù†ÙˆÛŒØ³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</h2>
                <p class="text-gray-400 font-bold text-sm bg-gray-100 dark:bg-gray-800 inline-block px-4 py-2 rounded-full">SRT ÛŒØ§ VTT</p>
                <input type="file" id="fileInput" accept=".srt,.vtt" class="hidden" onchange="handleFileUpload(this.files[0])">
            </div>
        </div>

        <!-- Panels Container -->
        <div class="flex-1 flex flex-col md:flex-row w-full h-full">
            <!-- Original Text Panel -->
            <div class="flex-1 flex flex-col border-b-2 md:border-b-0 md:border-l-2 border-gray-200 dark:border-gray-800 h-1/2 md:h-full relative">
                <div class="bg-white dark:bg-gray-900 p-3 flex justify-between items-center border-b border-gray-100 dark:border-gray-800">
                    <span class="text-xs font-black text-gray-400 uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-file-lines"></i> Ø²ÛŒØ±Ù†ÙˆÛŒØ³ Ø§ØµÙ„ÛŒ
                    </span>
                    <span id="originalLineCount" class="bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-lg text-xs font-black text-gray-600 dark:text-gray-300">0</span>
                </div>
                <div id="originalContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-[#0a0a0a]">
                    <!-- Items -->
                </div>
            </div>

            <!-- Translated Text Panel -->
            <div class="flex-1 flex flex-col h-1/2 md:h-full relative">
                <div class="bg-purple-50 dark:bg-purple-900/10 p-3 flex justify-between items-center border-b border-purple-100 dark:border-purple-900/20">
                    <span class="text-xs font-black text-purple-600 dark:text-purple-400 uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-language text-lg"></i> Ø®Ø±ÙˆØ¬ÛŒ ØªØ±Ø¬Ù…Ù‡
                    </span>
                    <div class="flex gap-2">
                        <span id="translatedLineCount" class="bg-white dark:bg-gray-800 px-3 py-1 rounded-lg text-xs font-black text-purple-600 dark:text-purple-300">0</span>
                        <button onclick="copyTranslation()" class="text-purple-500 hover:text-purple-700 dark:hover:text-white transition transform hover:scale-110"><i class="fa-regular fa-copy text-lg"></i></button>
                    </div>
                </div>
                <div id="translatedContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-purple-50/30 dark:bg-[#0d0d12]">
                    <!-- Items -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Control -->
    <footer class="glass border-t border-gray-200 dark:border-gray-800 p-4 pb-8 sm:pb-4 shrink-0 z-40">
        <div class="max-w-7xl mx-auto w-full">
            <div class="flex justify-between text-[10px] sm:text-xs font-bold text-gray-500 dark:text-gray-400 mb-3 font-mono">
                <span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div> <span id="progressPercent">0%</span></span>
                <!-- Time Displays -->
                <div class="flex gap-3">
                    <span class="bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded text-gray-600 dark:text-gray-300" title="Ø²Ù…Ø§Ù† Ø³Ù¾Ø±ÛŒ Ø´Ø¯Ù‡">
                        <i class="fa-solid fa-hourglass-start mr-1 text-blue-500"></i><span id="timeElapsed">00:00</span>
                    </span>
                    <span class="bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded text-gray-600 dark:text-gray-300" title="Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ®Ù…ÛŒÙ†ÛŒ">
                        <i class="fa-solid fa-hourglass-end mr-1 text-purple-500"></i><span id="timeRemaining">--:--</span>
                    </span>
                </div>
            </div>
            
            <div class="w-full bg-gray-200 dark:bg-gray-800 rounded-full h-2 mb-4 overflow-hidden">
                <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-300 shadow-[0_0_15px_rgba(139,92,246,0.5)]" style="width: 0%"></div>
            </div>

            <div class="flex gap-3">
                <button onclick="resetApp()" class="btn-pop btn-red w-12 sm:w-16 rounded-2xl flex items-center justify-center text-lg" title="Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ùˆ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯">
                    <i class="fa-solid fa-trash-can"></i>
                </button>

                <button id="stopBtn" onclick="stopTranslation()" class="hidden btn-pop btn-gray flex-1 py-3 rounded-2xl font-black text-sm text-red-500 border-red-200 dark:border-red-900/30 bg-red-50 dark:bg-red-900/10">
                    <i class="fa-solid fa-pause ml-2"></i> ØªÙˆÙ‚Ù Ù…ÙˆÙ‚Øª
                </button>
                
                <button id="startBtn" onclick="startTranslationProcess()" class="btn-pop btn-purple flex-1 py-3 rounded-2xl font-black text-sm shadow-xl shadow-purple-500/20 disabled:opacity-50 disabled:transform-none disabled:border-b-0 group">
                    <i class="fa-solid fa-play ml-2 group-hover:scale-110 transition-transform"></i> <span id="startBtnText">Ø´Ø±ÙˆØ¹ ØªØ±Ø¬Ù…Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯</span>
                </button>
            </div>
        </div>
    </footer>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed', err));
            });
        }
    </script>

    <!-- App Logic -->
    <script>
        // --- Theme & Initial Setup ---
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'light') document.documentElement.classList.remove('dark');

        const state = {
            subtitles: [],
            isTranslating: false,
            abortController: null,
            startTime: null,
            startLineCount: 0,
            timerInterval: null, 
            originalFileName: "subtitle", 
            currentProjectId: null,
            settings: {
                provider: 'gemini',
                apiKeys: '',
                model: '',
                targetLang: 'Persian',
                tone: 'standard',
                temperature: 0.3,
                chunkSize: 20
            }
        };

        const defaultModels = {
            gemini: ['gemini-2.0-flash-exp', 'gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-1.0-pro'],
            openrouter: ['google/gemini-flash-1.5', 'openai/gpt-4o', 'anthropic/claude-3.5-sonnet']
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            updateUIFromSettings();
            loadHistoryList(); 
            
            document.getElementById('tempRange').addEventListener('input', (e) => document.getElementById('tempValue').textContent = e.target.value);
            document.getElementById('chunkRange').addEventListener('input', (e) => document.getElementById('chunkValue').textContent = e.target.value);
            
            const lastId = localStorage.getItem('last_active_project');
            if(lastId) loadProject(lastId);
            
            document.addEventListener('click', function(event) {
                const menu = document.getElementById('downloadMenu');
                const btn = document.querySelector('[onclick="toggleDownloadMenu(event)"]');
                if (menu && !menu.classList.contains('hidden') && !menu.contains(event.target) && !btn.contains(event.target)) {
                    menu.classList.add('hidden');
                }
            });
        });

        // --- Multi-Key Management ---
        function getKeysList() {
            const val = document.getElementById('apiKeysInput').value;
            return val ? val.split(',').map(k => k.trim()).filter(k => k) : [];
        }

        function renderKeysList() {
            const list = getKeysList();
            const container = document.getElementById('keysListDisplay');
            container.innerHTML = '';
            
            if(list.length === 0) {
                container.innerHTML = '<div class="text-xs text-gray-400 text-center py-2">Ù‡ÛŒÚ† Ú©Ù„ÛŒØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                return;
            }

            list.forEach((key, index) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white dark:bg-gray-900 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 text-xs";
                const maskedKey = key.length > 8 ? key.substring(0, 4) + '...' + key.substring(key.length - 4) : '******';
                div.innerHTML = `
                    <span class="font-mono text-gray-600 dark:text-gray-300 font-bold">${index + 1}. ${maskedKey}</span>
                    <button onclick="removeKey(${index})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                `;
                container.appendChild(div);
            });
        }

        function addKeyFromInput() {
            const input = document.getElementById('newKeyInput');
            const newKey = input.value.trim();
            if(!newKey) return alert("Ù„Ø·ÙØ§ Ú©Ù„ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
            
            const currentKeys = getKeysList();
            if(currentKeys.includes(newKey)) return alert("Ø§ÛŒÙ† Ú©Ù„ÛŒØ¯ Ù‚Ø¨Ù„Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª");
            
            currentKeys.push(newKey);
            document.getElementById('apiKeysInput').value = currentKeys.join(',');
            input.value = '';
            renderKeysList();
        }

        function removeKey(index) {
            const list = getKeysList();
            list.splice(index, 1);
            document.getElementById('apiKeysInput').value = list.join(',');
            renderKeysList();
        }

        // --- History Logic ---
        function getHistory() {
            try { return JSON.parse(localStorage.getItem('subtitle_history_meta') || '[]'); } catch { return []; }
        }

        function saveProjectSnapshot() {
            if(!state.subtitles.length) return;
            const id = state.currentProjectId || Date.now().toString();
            state.currentProjectId = id;
            localStorage.setItem('last_active_project', id);

            const projectData = {
                fileName: state.originalFileName,
                subtitles: state.subtitles,
                date: Date.now()
            };
            localStorage.setItem('proj_' + id, JSON.stringify(projectData));

            let history = getHistory();
            history = history.filter(h => h.id !== id);
            history.unshift({
                id: id,
                name: state.originalFileName,
                date: Date.now(),
                progress: Math.round((state.subtitles.filter(s=>s.translatedText).length / state.subtitles.length) * 100)
            });
            
            if(history.length > 10) {
                const removed = history.pop();
                localStorage.removeItem('proj_' + removed.id);
            }
            localStorage.setItem('subtitle_history_meta', JSON.stringify(history));
        }

        function loadHistoryList() {
            const list = document.getElementById('historyList');
            const history = getHistory();
            list.innerHTML = '';
            if(history.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-4 text-xs">ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
                return;
            }
            history.forEach(item => {
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center bg-gray-50 dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700 cursor-pointer hover:border-blue-500 transition group';
                el.innerHTML = `
                    <div class="flex-1" onclick="loadProject('${item.id}'); toggleHistory()">
                        <div class="font-bold text-sm text-gray-800 dark:text-gray-200 truncate w-48" dir="ltr">${item.name}</div>
                        <div class="text-[10px] text-gray-500 flex gap-2">
                            <span>${new Date(item.date).toLocaleDateString('fa-IR')}</span>
                            <span class="${item.progress === 100 ? 'text-green-500' : 'text-blue-500'}">${item.progress}%</span>
                        </div>
                    </div>
                    <button onclick="deleteProject('${item.id}')" class="text-red-400 hover:text-red-600 px-2 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                `;
                list.appendChild(el);
            });
        }

        function loadProject(id) {
            const dataStr = localStorage.getItem('proj_' + id);
            if(!dataStr) return;
            const data = JSON.parse(dataStr);
            state.subtitles = data.subtitles;
            state.originalFileName = data.fileName;
            state.currentProjectId = id;
            document.getElementById('uploadOverlay').classList.add('opacity-0', 'pointer-events-none');
            renderSubtitles();
            updateProgressUI();
            updateStartButtonText();
        }

        function deleteProject(id) {
            if(!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
            let history = getHistory().filter(h => h.id !== id);
            localStorage.setItem('subtitle_history_meta', JSON.stringify(history));
            localStorage.removeItem('proj_' + id);
            loadHistoryList();
            if(state.currentProjectId === id) resetApp();
        }

        function toggleHistory() {
            const modal = document.getElementById('historyModal');
            if(modal.classList.contains('hidden')) {
                loadHistoryList();
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        // --- Rewrite Logic (FIXED & IMPROVED) ---
        function toggleRewriteMenu(index) {
            const menu = document.getElementById(`menu-${index}`);
            // Toggle visibility
            if(menu.classList.contains('hidden')) {
                // Close others
                document.querySelectorAll('[id^="menu-"]').forEach(m => m.classList.add('hidden'));
                menu.classList.remove('hidden');
                menu.classList.add('animate-slide-down');
            } else {
                menu.classList.add('hidden');
            }
        }

        // --- ROBUST RETRY LOGIC ---
        async function fetchWithRetry(url, options, retries = 5, backoff = 2000) {
            try {
                const res = await fetch(url, options);
                
                // If success, return immediately
                if (res.ok) return res;

                // Retry on rate limit (429) or server overload (503) or generic server error (500)
                if (res.status === 429 || res.status === 503 || res.status === 500) {
                    if (retries > 0) {
                        console.warn(`Server busy (${res.status}). Retrying in ${backoff/1000}s... (Attempts left: ${retries})`);
                        await new Promise(r => setTimeout(r, backoff));
                        return fetchWithRetry(url, options, retries - 1, backoff * 2); // Exponential backoff
                    }
                }
                
                return res; // Return error response if retries exhausted
            } catch (e) {
                // Retry on network errors (e.g. lost connection)
                if (retries > 0) {
                    console.warn(`Network error. Retrying in ${backoff/1000}s... (Attempts left: ${retries})`);
                    await new Promise(r => setTimeout(r, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw e;
            }
        }

        async function rewriteLine(index, mode) {
            const sub = state.subtitles[index];
            if(!state.settings.apiKeys) return alert("Ù„Ø·ÙØ§ Ú©Ù„ÛŒØ¯ API Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
            const apiKey = state.settings.apiKeys.split(',')[0].trim();
            if(!apiKey) return alert("Ú©Ù„ÛŒØ¯ API Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");
            
            const card = document.getElementById(`trans-${index}`);
            const textarea = card.querySelector('textarea');
            const originalText = textarea.value;
            
            textarea.value = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ... (Ù„Ø·ÙØ§ ØµØ¨Ø± Ú©Ù†ÛŒØ¯)";
            textarea.disabled = true;
            
            let instruction = "";
            switch(mode) {
                case 'short': instruction = "Make translation shorter and concise. Use spoken colloquial style."; break;
                case 'formal': instruction = "Make translation formal and polite."; break;
                case 'casual': instruction = "Make translation VERY casual and spoken (Tehrani slang if Persian)."; break;
                case 'retry': instruction = "Translate again with different wording. Keep it spoken style."; break;
            }

            const prompt = `
            Original: "${sub.originalText}"
            Current Translation: "${sub.translatedText}"
            Target Language: ${state.settings.targetLang}
            Task: Rewrite the translation based on this instruction: "${instruction}".
            Return ONLY the new translated text string. No quotes.`;

            try {
                let newText = "";
                const modelName = state.settings.model || 'gemini-1.5-flash';
                if(state.settings.provider === 'gemini') {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                    
                    const res = await fetchWithRetry(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    const data = await res.json();
                    
                    if (!res.ok) {
                        throw new Error(data.error?.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± Gemini");
                    }
                    if (!data.candidates || !data.candidates[0]) {
                         throw new Error("Ù¾Ø§Ø³Ø®ÛŒ Ø§Ø² Ù…Ø¯Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯");
                    }
                    newText = data.candidates[0].content.parts[0].text.trim();
                } else {
                    const res = await fetchWithRetry('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: state.settings.model || 'google/gemini-flash-1.5',
                            messages: [{role: 'user', content: prompt}]
                        })
                    });
                    
                    const data = await res.json();
                    
                    if (!res.ok) {
                         throw new Error(data.error?.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± OpenRouter");
                    }
                    if (!data.choices || !data.choices[0]) {
                         throw new Error("Ù¾Ø§Ø³Ø®ÛŒ Ø§Ø² Ù…Ø¯Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯");
                    }
                    newText = data.choices[0].message.content.trim();
                }
                
                state.subtitles[index].translatedText = newText;
                textarea.value = newText;
                saveProjectSnapshot(); 
            } catch(e) {
                alert("Ø®Ø·Ø§: " + e.message);
                textarea.value = originalText;
            } finally {
                textarea.disabled = false;
                autoResize(textarea);
            }
        }

        // --- Settings Logic ---
        function toggleSettings() { document.getElementById('settingsModal').classList.toggle('hidden'); }
        function handleModalClick(event) { if (event.target.id.includes('Modal')) event.target.classList.add('hidden'); }
        function toggleDownloadMenu(e) { e.stopPropagation(); document.getElementById('downloadMenu').classList.toggle('hidden'); }
        function setService(service) { state.settings.provider = service; updateUIFromSettings(); document.getElementById('modelSelect').innerHTML = '<option disabled selected>Ù„ÛŒØ³Øª Ø±Ø§ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†ÛŒØ¯...</option>'; }
        
        function saveSettings() {
            state.settings.apiKeys = document.getElementById('apiKeysInput').value;
            state.settings.model = document.getElementById('modelSelect').value;
            state.settings.targetLang = document.getElementById('targetLang').value;
            state.settings.tone = document.getElementById('toneSelect').value;
            state.settings.temperature = parseFloat(document.getElementById('tempRange').value);
            state.settings.chunkSize = parseInt(document.getElementById('chunkRange').value);
            localStorage.setItem('translator_settings', JSON.stringify(state.settings));
            updateUIFromSettings();
        }

        function loadSettings() {
            const stored = localStorage.getItem('translator_settings');
            if(stored) state.settings = { ...state.settings, ...JSON.parse(stored) };
        }

        function updateUIFromSettings() {
            const isGemini = state.settings.provider === 'gemini';
            document.getElementById('btn-gemini').className = `btn-pop p-4 rounded-2xl text-sm font-bold flex flex-col items-center gap-2 border-2 transition-all ${isGemini ? 'btn-blue border-b-4 border-blue-600 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400' : 'btn-gray bg-gray-50 dark:bg-gray-800 text-gray-400 border-gray-200 dark:border-gray-700'}`;
            document.getElementById('btn-openrouter').className = `btn-pop p-4 rounded-2xl text-sm font-bold flex flex-col items-center gap-2 border-2 transition-all ${!isGemini ? 'btn-blue border-b-4 border-blue-600 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400' : 'btn-gray bg-gray-50 dark:bg-gray-800 text-gray-400 border-gray-200 dark:border-gray-700'}`;
            document.getElementById('apiKeysInput').value = state.settings.apiKeys;
            document.getElementById('targetLang').value = state.settings.targetLang;
            document.getElementById('toneSelect').value = state.settings.tone;
            document.getElementById('tempRange').value = state.settings.temperature;
            document.getElementById('tempValue').textContent = state.settings.temperature;
            document.getElementById('chunkRange').value = state.settings.chunkSize;
            document.getElementById('chunkValue').textContent = state.settings.chunkSize;
            
            // Render Keys List
            renderKeysList();

            if(state.settings.model) {
                const select = document.getElementById('modelSelect');
                if(select.options.length <= 1) {
                    const opt = document.createElement('option');
                    opt.value = state.settings.model; opt.textContent = state.settings.model; opt.selected = true; select.add(opt);
                }
            }
        }

        async function checkConnection() {
            const keys = document.getElementById('apiKeysInput').value.split(',').map(k => k.trim()).filter(k=>k);
            const status = document.getElementById('connectionStatus');
            if(!keys.length) return status.innerHTML = "<span class='text-red-500'>Ú©Ù„ÛŒØ¯ API Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</span>";
            status.innerHTML = "<span class='text-blue-500'><i class='fa-solid fa-spinner fa-spin'></i> Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</span>";
            try {
                const key = keys[0];
                if(state.settings.provider === 'gemini') {
                    // Use retry here too for robustness
                    const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`, {}, 2); 
                    if(res.ok) status.innerHTML = "<span class='text-green-500'><i class='fa-solid fa-check'></i> Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚!</span>"; else throw new Error('Error');
                } else {
                    const res = await fetchWithRetry('https://openrouter.ai/api/v1/auth/key', { headers: { 'Authorization': `Bearer ${key}` } }, 2);
                    if(res.ok) status.innerHTML = "<span class='text-green-500'><i class='fa-solid fa-check'></i> Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚!</span>"; else throw new Error('Error');
                }
                refreshModels(); 
            } catch(e) { status.innerHTML = "<span class='text-red-500'><i class='fa-solid fa-xmark'></i> Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</span>"; }
        }

        async function refreshModels() {
            const btn = document.getElementById('refreshModelsBtn');
            const select = document.getElementById('modelSelect');
            const keys = document.getElementById('apiKeysInput').value.split(',').map(k => k.trim()).filter(k=>k);
            if(!keys.length) return alert("Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ú©Ù„ÛŒØ¯ API Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
            btn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> Ø¯Ø±ÛŒØ§ÙØª...";
            select.innerHTML = "<option>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>";
            try {
                let models = [];
                const key = keys[0];
                if(state.settings.provider === 'gemini') {
                    const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`, {}, 2);
                    const data = await res.json();
                    models = data.models.filter(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes('generateContent')).map(m => m.name.replace('models/', ''));
                } else {
                    const res = await fetchWithRetry('https://openrouter.ai/api/v1/models', {}, 2);
                    const data = await res.json();
                    models = data.data.map(m => m.id);
                }
                select.innerHTML = "";
                models.sort().forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m; opt.textContent = m;
                    if(m === state.settings.model) opt.selected = true;
                    select.appendChild(opt);
                });
                if(!state.settings.model || !models.includes(state.settings.model)) select.selectedIndex = 0;
            } catch(e) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª: " + e.message); populateModelDropdownDefaults(); } finally { btn.innerHTML = "<i class='fa-solid fa-rotate'></i> Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„"; }
        }

        function populateModelDropdownDefaults() {
             const select = document.getElementById('modelSelect');
             select.innerHTML = '';
             const models = defaultModels[state.settings.provider];
             models.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; select.appendChild(opt); });
        }

        function handleFileUpload(file) {
            if(!file) return;
            state.originalFileName = file.name.replace(/\.[^/.]+$/, "");
            state.currentProjectId = Date.now().toString(); 
            const reader = new FileReader();
            reader.onload = (e) => {
                parseSubtitle(e.target.result);
                document.getElementById('uploadOverlay').classList.add('opacity-0', 'pointer-events-none');
                saveProjectSnapshot();
            };
            reader.readAsText(file);
        }

        function parseSubtitle(text) {
            const pattern = /(\d+)\r?\n(\d{2}:\d{2}:\d{2},\d{3} --> \d{2}:\d{2}:\d{2},\d{3})\r?\n([\s\S]*?)(?=\r?\n\r?\n\d+|\r?\n\r?\n?$)/g;
            state.subtitles = [];
            let match;
            while ((match = pattern.exec(text)) !== null) {
                state.subtitles.push({ id: match[1], time: match[2], originalText: match[3].trim(), translatedText: '' });
            }
            if(state.subtitles.length === 0) {
                 const blocks = text.trim().split(/\n\s*\n/);
                 state.subtitles = blocks.map((block) => {
                     const lines = block.split('\n');
                     if(lines.length >= 3) return { id: lines[0], time: lines[1], originalText: lines.slice(2).join('\n').trim(), translatedText: '' };
                     return null;
                 }).filter(Boolean);
            }
            renderSubtitles();
            updateStartButtonText();
        }

        function renderSubtitles() {
            const oCon = document.getElementById('originalContainer');
            const tCon = document.getElementById('translatedContainer');
            oCon.innerHTML = ''; tCon.innerHTML = '';
            document.getElementById('originalLineCount').textContent = state.subtitles.length;

            const fragO = document.createDocumentFragment();
            const fragT = document.createDocumentFragment();

            state.subtitles.forEach((sub, i) => {
                const divO = document.createElement('div');
                divO.className = 'subtitle-card p-4 rounded-2xl bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 text-sm text-gray-700 dark:text-gray-300 shadow-sm';
                divO.id = `orig-${i}`;
                divO.innerHTML = `<div class="text-[10px] text-gray-400 font-bold mb-2 flex justify-between tracking-wide"><span><i class="fa-solid fa-hashtag mr-1"></i>${sub.id}</span><span>${sub.time}</span></div><div dir="auto" class="font-medium leading-relaxed">${sub.originalText.replace(/\n/g, '<br>')}</div>`;
                fragO.appendChild(divO);

                const divT = document.createElement('div');
                divT.className = 'subtitle-card p-4 rounded-2xl bg-white dark:bg-gray-800 border-2 border-transparent focus-within:border-purple-400 dark:focus-within:border-purple-500 text-sm shadow-sm transition-all duration-300 relative group';
                divT.id = `trans-${i}`;
                
                // NEW: Toolbar integrated into header
                const toolbar = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-[10px] text-gray-400 font-bold tracking-wide">
                            <span><i class="fa-solid fa-hashtag mr-1"></i>${sub.id}</span>
                            <span class="ml-2">${sub.time}</span>
                        </div>
                        <button onclick="toggleRewriteMenu(${i})" class="text-gray-300 hover:text-purple-500 bg-gray-50 dark:bg-gray-700/50 rounded-full w-6 h-6 flex items-center justify-center transition" title="Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ"><i class="fa-solid fa-wand-magic-sparkles text-xs"></i></button>
                    </div>
                    
                    <div id="menu-${i}" class="hidden flex flex-wrap gap-2 mb-3 bg-gray-50 dark:bg-gray-700/30 p-2 rounded-lg text-xs">
                        <button onclick="rewriteLine(${i}, 'short')" class="bg-white dark:bg-gray-800 px-2 py-1 rounded shadow-sm hover:text-blue-500">Ú©ÙˆØªØ§Ù‡â€ŒØªØ±</button>
                        <button onclick="rewriteLine(${i}, 'formal')" class="bg-white dark:bg-gray-800 px-2 py-1 rounded shadow-sm hover:text-blue-500">Ø±Ø³Ù…ÛŒâ€ŒØªØ±</button>
                        <button onclick="rewriteLine(${i}, 'casual')" class="bg-white dark:bg-gray-800 px-2 py-1 rounded shadow-sm hover:text-blue-500">Ø¯ÙˆØ³ØªØ§Ù†Ù‡</button>
                        <button onclick="rewriteLine(${i}, 'retry')" class="bg-white dark:bg-gray-800 px-2 py-1 rounded shadow-sm text-purple-500">ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</button>
                    </div>
                `;

                const textarea = document.createElement('textarea');
                textarea.className = 'w-full bg-transparent border-none focus:ring-0 text-gray-800 dark:text-gray-100 resize-none overflow-hidden placeholder-gray-300 dark:placeholder-gray-600 font-medium leading-relaxed';
                textarea.value = sub.translatedText;
                textarea.placeholder = '...';
                textarea.oninput = (e) => {
                    state.subtitles[i].translatedText = e.target.value;
                    autoResize(e.target);
                };
                
                divT.innerHTML = toolbar;
                divT.appendChild(textarea);
                fragT.appendChild(divT);
            });
            oCon.appendChild(fragO);
            tCon.appendChild(fragT);
            
            requestAnimationFrame(() => {
                document.querySelectorAll('#translatedContainer textarea').forEach(autoResize);
            });
        }

        function autoResize(el) { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }

        async function startTranslationProcess() {
            const keys = state.settings.apiKeys.split(',').map(k => k.trim()).filter(k => k);
            if(keys.length === 0) return alert('Ù„Ø·ÙØ§ Ú©Ù„ÛŒØ¯ API Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
            state.isTranslating = true;
            state.abortController = new AbortController();
            state.startTime = Date.now();
            state.startLineCount = state.subtitles.filter(s => s.translatedText).length;
            clearInterval(state.timerInterval);
            state.timerInterval = setInterval(() => {
                if(!state.startTime) return;
                const now = Date.now();
                document.getElementById('timeElapsed').textContent = formatTime(now - state.startTime);
            }, 1000);

            let startIndex = state.subtitles.findIndex(s => !s.translatedText);
            if (startIndex === -1) {
                if(confirm('ØªØ±Ø¬Ù…Ù‡ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¢ÛŒØ§ Ù…Ø¬Ø¯Ø¯ Ø§Ø² Ø§ÙˆÙ„ Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯ØŸ')) startIndex = 0;
                else { state.isTranslating = false; clearInterval(state.timerInterval); return; }
            }
            setRunningState(true);

            try {
                const tonePrompts = {
                    'uncensored': "STYLE: VERY COLLOQUIAL, STREET SLANG, R-RATED. DO NOT CENSOR PROFANITY. BE RAW AND REAL.",
                    'casual': "STYLE: EXTREMELY CASUAL SPOKEN LANGUAGE (Ù…Ø­Ø§ÙˆØ±Ù‡â€ŒØ§ÛŒ Ùˆ Ú¯ÙØªØ§Ø±ÛŒ). USE SHORT, SIMPLE SENTENCES LIKE FRIENDS TALKING. AVOID BOOKISH WORDS (Ù…Ø«Ù„Ø§ Ø¨Ù‡ Ø¬Ø§ÛŒ Â«Ù…ÛŒâ€ŒØ±ÙˆÙ…Â» Ø¨Ú¯Ùˆ Â«Ù…ÛŒØ±Ù…Â»). MAKE IT EASY TO READ QUICKLY.",
                    'action': "STYLE: FAST-PACED SPOKEN LANGUAGE. SHORT, PUNCHY SENTENCES. USE AGGRESSIVE OR TENSE TONE IF NEEDED BUT KEEP IT COLLOQUIAL (Ú¯ÙØªØ§Ø±ÛŒ).",
                    'drama': "STYLE: EMOTIONAL BUT SPOKEN/COLLOQUIAL (Ú¯ÙØªØ§Ø±ÛŒ). FOCUS ON FEELINGS BUT USE NATURAL EVERYDAY LANGUAGE. AVOID FORMAL LITERATURE STYLE.",
                    'comedy': "STYLE: FUNNY, WITTY, SPOKEN LANGUAGE. TRANSLATE JOKES TO LOCAL EQUIVALENTS IF POSSIBLE. KEEP IT CASUAL.",
                    'scifi': "STYLE: USE TECH TERMS ACCURATELY BUT KEEP THE DIALOGUE FLOW SPOKEN AND NATURAL.",
                    'horror': "STYLE: SPOKEN LANGUAGE, SUSPENSEFUL. SHORT SENTENCES.",
                    'kids': "STYLE: SIMPLE SPOKEN LANGUAGE. EASY WORDS FOR KIDS.",
                    'slang': "STYLE: HEAVY USE OF STREET SLANG AND IDIOMS (Ø§ØµØ·Ù„Ø§Ø­Ø§Øª Ú©ÙˆÚ†Ù‡ Ø¨Ø§Ø²Ø§Ø±ÛŒ).",
                    'standard': "STYLE: STANDARD SUBTITLE, BUT FLUENT AND NATURAL."
                };
                const toneInstruction = tonePrompts[state.settings.tone] || tonePrompts['standard'];
                const prompt = `Translate the following subtitle lines to ${state.settings.targetLang}. ${toneInstruction} IMPORTANT RULES: 1. Return ONLY a JSON Array of strings. 2. The length of the array MUST match the input exactly. 3. Preserve all line breaks and punctuation. 4. Do NOT include markdown formatting. 5. FOR PERSIAN: USE "SPOKEN" (Ù…Ø­Ø§ÙˆØ±Ù‡â€ŒØ§ÛŒ) FORM FOR VERBS AND PRONOUNS (e.g., 'mikonam' instead of 'mi-konam', 'mire' instead of 'miravad').`;

                for (let i = startIndex; i < state.subtitles.length; i += state.settings.chunkSize) {
                    if (!state.isTranslating) break;
                    const chunkEnd = Math.min(i + state.settings.chunkSize, state.subtitles.length);
                    const chunkData = state.subtitles.slice(i, chunkEnd);
                    const textArray = chunkData.map(s => s.originalText);
                    highlightChunk(i, chunkEnd);
                    let result = [];
                    let success = false;
                    for (const key of keys) {
                        try {
                            const signal = state.abortController.signal;
                            if (state.settings.provider === 'gemini') {
                                const url = `https://generativelanguage.googleapis.com/v1beta/models/${state.settings.model || 'gemini-1.5-flash'}:generateContent?key=${key}`;
                                
                                // Use fetchWithRetry here
                                const res = await fetchWithRetry(url, {
                                    method: 'POST', headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt + "\nINPUT JSON: " + JSON.stringify(textArray) }] }], generationConfig: { responseMimeType: "application/json", temperature: state.settings.temperature } }), signal
                                });
                                
                                if(!res.ok) throw new Error('Gemini Error');
                                result = JSON.parse((await res.json()).candidates[0].content.parts[0].text);
                            } else {
                                const res = await fetchWithRetry('https://openrouter.ai/api/v1/chat/completions', {
                                    method: 'POST', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json', 'HTTP-Referer': window.location.href },
                                    body: JSON.stringify({ model: state.settings.model || 'google/gemini-flash-1.5', messages: [{role: 'system', content: prompt}, {role: 'user', content: JSON.stringify(textArray)}], temperature: state.settings.temperature }), signal
                                });
                                if(!res.ok) throw new Error('OpenRouter Error');
                                let content = (await res.json()).choices[0].message.content.trim();
                                result = JSON.parse(content.replace(/```json|```/g, ''));
                            }
                            success = true; break;
                        } catch (e) { console.warn('API Retry', e); }
                    }
                    if (!success) throw new Error('Ù‡Ù…Ù‡ Ú©Ù„ÛŒØ¯Ù‡Ø§ Ø®Ø·Ø§ Ø¯Ø§Ø¯Ù†Ø¯.');
                    while(result.length < textArray.length) result.push("");
                    for(let j=0; j<chunkData.length; j++) {
                        const idx = i + j;
                        state.subtitles[idx].translatedText = result[j];
                        const ta = document.querySelector(`#trans-${idx} textarea`);
                        if(ta) { ta.value = result[j]; autoResize(ta); }
                    }
                    saveProjectSnapshot();
                    updateProgressUI(i + chunkData.length, state.subtitles.length);
                    updateTimeRemaining();
                    await new Promise(r => setTimeout(r, 500)); 
                }
            } catch (e) { if(e.name !== 'AbortError') alert('Ø®Ø·Ø§: ' + e.message); } finally { setRunningState(false); updateStartButtonText(); clearInterval(state.timerInterval); }
        }

        function updateTimeRemaining() {
            if(!state.startTime) return;
            const now = Date.now();
            const elapsed = now - state.startTime;
            const currentDone = state.subtitles.filter(s => s.translatedText).length;
            const sessionDone = currentDone - state.startLineCount;
            if (sessionDone > 0) {
                const msPerLine = elapsed / sessionDone;
                const remainingLines = state.subtitles.length - currentDone;
                const remainingMs = remainingLines * msPerLine;
                document.getElementById('timeRemaining').textContent = formatTime(remainingMs);
            }
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function resetApp() {
            if(confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ ÙØ§ÛŒÙ„ ÙØ¹Ù„ÛŒ Ø¨Ø³ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.")) {
                state.subtitles = []; state.currentProjectId = null; localStorage.removeItem('last_active_project');
                renderSubtitles(); updateProgressUI(0,0);
                document.getElementById('timeElapsed').textContent = "00:00"; document.getElementById('timeRemaining').textContent = "--:--";
                document.getElementById('uploadOverlay').classList.remove('opacity-0', 'pointer-events-none');
                document.getElementById('fileInput').value = '';
                stopTranslation();
            }
        }

        function stopTranslation() {
            if(state.isTranslating) { if (confirm("Ù…ØªÙˆÙ‚Ù Ø´ÙˆØ¯ØŸ")) { if(state.abortController) state.abortController.abort(); state.isTranslating = false; clearInterval(state.timerInterval); setRunningState(false); } }
        }

        function setRunningState(isRunning) {
            document.getElementById('startBtn').classList.toggle('hidden', isRunning);
            document.getElementById('stopBtn').classList.toggle('hidden', !isRunning);
            if(!isRunning) removeHighlights();
        }

        function exportSubtitle(format) {
            if(!state.subtitles.length) return alert('ÙØ§ÛŒÙ„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
            let content = "";
            const isVtt = format === 'vtt';
            if(isVtt) content += "WEBVTT\n\n";
            state.subtitles.forEach((s, i) => {
                let time = s.time;
                if(isVtt) time = time.replace(/,/g, '.'); else time = time.replace(/\./g, ',');
                const text = s.translatedText || s.originalText;
                if(isVtt) content += `${time}\n${text}\n\n`; else content += `${i+1}\n${time}\n${text}\n\n`;
            });
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const suffix = state.settings.tone === 'standard' ? '' : `_${state.settings.tone}`;
            a.href = url; a.download = `${state.originalFileName}_${state.settings.targetLang}${suffix}.${format}`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function highlightChunk(start, end) {
            removeHighlights();
            for(let i=start; i<end; i++) {
                document.getElementById(`orig-${i}`)?.classList.add('active');
                document.getElementById(`trans-${i}`)?.classList.add('active');
            }
            document.getElementById(`trans-${start}`)?.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
        function removeHighlights() { document.querySelectorAll('.active').forEach(e => e.classList.remove('active')); }
        function updateProgressUI(curr, total) {
            if(!curr) { curr = state.subtitles.filter(s=>s.translatedText).length; total = state.subtitles.length; }
            const pct = total ? Math.round((curr/total)*100) : 0;
            document.getElementById('progressBar').style.width = `${pct}%`;
            document.getElementById('progressPercent').textContent = `${pct}%`;
            document.getElementById('translatedLineCount').textContent = curr;
        }
        function updateStartButtonText() {
            const count = state.subtitles.filter(s => s.translatedText).length;
            document.getElementById('startBtnText').textContent = (count > 0 && count < state.subtitles.length) ? "Ø§Ø¯Ø§Ù…Ù‡ ØªØ±Ø¬Ù…Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯" : "Ø´Ø±ÙˆØ¹ ØªØ±Ø¬Ù…Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯";
        }
        function copyTranslation() {
             const content = state.subtitles.map((s,i) => `${i+1}\n${s.time}\n${s.translatedText||s.originalText}\n`).join('\n');
             navigator.clipboard.writeText(content).then(() => alert('Ú©Ù¾ÛŒ Ø´Ø¯'));
        }
    </script>
</body>
</html>